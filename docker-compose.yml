services:
  kafka:
    image: obsidiandynamics/kafka
    restart: "no"
    ports:
      - "2181:2181"
      - "9092:9092"
    environment:
      KAFKA_LISTENERS: "INTERNAL://:29092,EXTERNAL://:9092"
      KAFKA_ADVERTISED_LISTENERS: "INTERNAL://kafka:29092,EXTERNAL://localhost:9092"
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: "INTERNAL:PLAINTEXT,EXTERNAL:PLAINTEXT"
      KAFKA_INTER_BROKER_LISTENER_NAME: "INTERNAL"
      KAFKA_ZOOKEEPER_SESSION_TIMEOUT: "6000"
      KAFKA_RESTART_ATTEMPTS: "10"
      KAFKA_RESTART_DELAY: "5"
      ZOOKEEPER_AUTOPURGE_PURGE_INTERVAL: "0"
      KAFKA_CREATE_TOPICS: "big-communal-orders-topic:1:1"
    healthcheck:
      test: ["CMD", "bash", "-c", "nc -z localhost 9092"]
      interval: 10s
      timeout: 5s
      retries: 10

  kafdrop:
    image: obsidiandynamics/kafdrop
    restart: "no"
    ports:
      - "9000:9000"
    environment:
      KAFKA_BROKERCONNECT: "kafka:29092"
    depends_on:
      - kafka

  analytics-postgres:
    image: postgres:16
    environment:
      POSTGRES_USER: analytics
      POSTGRES_PASSWORD: analytics
      POSTGRES_DB: analytics
    ports:
      - "5433:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U analytics -d analytics"]
      interval: 10s
      timeout: 5s
      retries: 5

  orders-postgres:
    image: postgres:16
    environment:
      POSTGRES_USER: orders
      POSTGRES_PASSWORD: orders
      POSTGRES_DB: orders
    ports:
      - "5434:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U orders -d orders"]
      interval: 10s
      timeout: 5s
      retries: 5

  wiremock-setup-core:
    image: rodolpheche/wiremock
    container_name: wiremock-setup-example
    ports:
      - "8031:8080"
    volumes:
      - ./wiremock-stubs/stubs/__files/:/home/wiremock/__files/
      - ./wiremock-stubs/stubs/mappings/:/home/wiremock/mappings/

  analytics-service:
    build:
      context: .
      dockerfile: analytics-service/Dockerfile
    depends_on:
      analytics-postgres:
        condition: service_healthy
    environment:
      SPRING_DATASOURCE_URL: jdbc:postgresql://analytics-postgres:5432/analytics
      SPRING_DATASOURCE_USERNAME: analytics
      SPRING_DATASOURCE_PASSWORD: analytics
      SPRING_FLYWAY_URL: jdbc:postgresql://analytics-postgres:5432/analytics
      SPRING_FLYWAY_USER: analytics
      SPRING_FLYWAY_PASSWORD: analytics
      ORDER_GRPC_TARGET: static://order-service:9090
      SERVER_PORT: 8081
    ports:
      - "8081:8081"

  order-service:
    build:
      context: .
      dockerfile: order-service/Dockerfile
    depends_on:
      kafka:
        condition: service_started
      wiremock-setup-core:
        condition: service_started
      orders-postgres:
        condition: service_healthy
    environment:
      KAFKA_BOOTSTRAP_SERVERS: kafka:29092
      GEO_BASE_URL: http://wiremock-setup-example:8080
      GRPC_SERVER_PORT: 9090
      SPRING_DATASOURCE_URL: jdbc:postgresql://orders-postgres:5432/orders
      SPRING_DATASOURCE_USERNAME: orders
      SPRING_DATASOURCE_PASSWORD: orders
      SPRING_FLYWAY_URL: jdbc:postgresql://orders-postgres:5432/orders
      SPRING_FLYWAY_USER: orders
      SPRING_FLYWAY_PASSWORD: orders
    ports:
      - "9090:9090"
