version: '3.9'
services:
  kafka:
    image: obsidiandynamics/kafka
    restart: "no"
    ports:
      - "2181:2181"
      - "9092:9092"
    environment:
      KAFKA_LISTENERS: "INTERNAL://:29092,EXTERNAL://:9092"
      KAFKA_ADVERTISED_LISTENERS: "INTERNAL://kafka:29092,EXTERNAL://localhost:9092"
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: "INTERNAL:PLAINTEXT,EXTERNAL:PLAINTEXT"
      KAFKA_INTER_BROKER_LISTENER_NAME: "INTERNAL"
      KAFKA_ZOOKEEPER_SESSION_TIMEOUT: "6000"
      KAFKA_RESTART_ATTEMPTS: "10"
      KAFKA_RESTART_DELAY: "5"
      ZOOKEEPER_AUTOPURGE_PURGE_INTERVAL: "0"
      KAFKA_CREATE_TOPICS: "big-communal-orders-topic:1:1"
    healthcheck:
      test: ["CMD", "bash", "-c", "nc -z localhost 9092"]
      interval: 10s
      timeout: 5s
      retries: 10

  kafdrop:
    image: obsidiandynamics/kafdrop
    restart: "no"
    ports:
      - "9000:9000"
    environment:
      KAFKA_BROKERCONNECT: "kafka:29092"
    depends_on:
      - kafka

  postgres:
    image: postgres:16
    environment:
      POSTGRES_USER: analytics
      POSTGRES_PASSWORD: analytics
      POSTGRES_DB: analytics
    ports:
      - "5433:5432"

  wiremock-setup-core:
    image: rodolpheche/wiremock
    container_name: wiremock-setup-example
    ports:
      - "8031:8080"
    volumes:
      - ./wiremock-stubs/stubs/__files/:/home/wiremock/__files/
      - ./wiremock-stubs/stubs/mappings/:/home/wiremock/mappings/

  analytics-service:
    build: ./analytics-service
    depends_on:
      - postgres
    environment:
      SPRING_DATASOURCE_URL: jdbc:postgresql://postgres:5432/analytics
      SPRING_DATASOURCE_USERNAME: analytics
      SPRING_DATASOURCE_PASSWORD: analytics
      GRPC_SERVER_PORT: 9091
    ports:
      - "9091:9091"

  order-service:
    build: ./order-service
    depends_on:
      kafka:
        condition: service_started
      wiremock-setup-core:
        condition: service_started
      analytics-service:
        condition: service_started
    environment:
      KAFKA_BOOTSTRAP_SERVERS: kafka:29092
      GEO_BASE_URL: http://wiremock-setup-example:8080
      ANALYTICS_GRPC_TARGET: static://analytics-service:9091
